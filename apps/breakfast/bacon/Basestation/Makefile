COMPONENT=BaseStationAppC

RX_SLACK?=20UL
CFLAGS += -DRX_SLACK=$(RX_SLACK)

TX_SLACK?=100UL
CFLAGS += -DTX_SLACK=$(TX_SLACK)

CFLAGS+=-DSERIAL_ADDRESS_FILTERING=1
CFLAGS += -DAM_ID_FROM_FLASH=0

CFLAGS += -I$(TOSROOT)/apps/breakfast/bacon/settingsStorage
CFLAGS += -I$(TOSDIR)/chips/msp430/tlvStorage

CFLAGS += -I$(TOSDIR)/lib/printf
CFLAGS += -I$(TOSDIR)/lib/serial
CFLAGS += -I$(TOSDIR)/lib/cxl/debug
CFLAGS += -I$(TOSDIR)/lib/cxl/am
CFLAGS += -I$(TOSDIR)/lib/cxl/mac
CFLAGS += -I$(TOSDIR)/lib/cxl/link
CFLAGS += -I$(TOSDIR)/lib/cxl/packet
CFLAGS += -I$(TOSDIR)/lib/cxl/scheduler
# CFLAGS += -I$(TOSDIR)/lib/cxl/routing
CFLAGS += -I$(TOSDIR)/lib/cx/routing
CFLAGS += -I$(TOSDIR)/lib/cx/debug
CFLAGS += -I$(TOSDIR)/lib/rf1a-tdma/timer

CFLAGS += -I$(TOSROOT)/apps/breakfast/bacon/RebootCounter
CFLAGS+=-I$(TOSDIR)/chips/msp430/tlvStorage

CFLAGS += -I$(TOSROOT)/apps/breakfast/util/stackGuard

ENABLE_PROBE_SCHEDULE_CONFIG?=0
CFLAGS += -DENABLE_PROBE_SCHEDULE_CONFIG=$(ENABLE_PROBE_SCHEDULE_CONFIG)

GLOBAL_CHANNEL?=0
CFLAGS +=-DGLOBAL_CHANNEL=$(GLOBAL_CHANNEL)

SUBNETWORK_CHANNEL?=32
CFLAGS +=-DSUBNETWORK_CHANNEL=$(SUBNETWORK_CHANNEL)

ROUTER_CHANNEL?=64
CFLAGS +=-DROUTER_CHANNEL=$(ROUTER_CHANNEL)

DEFAULT_MAX_DOWNLOAD_ROUNDS?=2
CFLAGS +=-DDEFAULT_MAX_DOWNLOAD_ROUNDS=$(DEFAULT_MAX_DOWNLOAD_ROUNDS)

PFLAGS+=-DMSP430XV2_DCO_CONFIG=MSP430XV2_DCO_32MHz_RSEL6
CFLAGS+=-DXT2_SMCLK

AM_POOL_SIZE ?= 7
CFLAGS += -DAM_POOL_SIZE=$(AM_POOL_SIZE)

#CFLAGS+= -DTOSH_DATA_LENGTH=109
CFLAGS+= -DRF1A_FEC_ENABLED=1
CFLAGS+= -DRF1A_WHITENING_ENABLED=1
CFLAGS+= -DRF1A_AUTOCAL=0

LPP_DEFAULT_PROBE_INTERVAL?=1024UL
CFLAGS += -DLPP_DEFAULT_PROBE_INTERVAL=$(LPP_DEFAULT_PROBE_INTERVAL)
CFLAGS += -DLPP_SLEEP_TIMEOUT=6144UL

CX_MAX_DEPTH?=8
CFLAGS += -DCX_MAX_DEPTH=$(CX_MAX_DEPTH)

CFLAGS += -DSELF_SFD_SYNCH=1
CFLAGS += -DPOWER_ADJUST=1

MAX_POWER?= 0x2D
CFLAGS += -DMAX_POWER=$(MAX_POWER)

MIN_POWER?= 0x03
CFLAGS += -DMIN_POWER=$(MIN_POWER)

FRAMELEN_FAST_SHORT?=37050UL
CFLAGS+=-DFRAMELEN_FAST_SHORT=$(FRAMELEN_FAST_SHORT)

CFLAGS += -DCX_BASESTATION=1


ENABLE_PRINTF ?= 1
CFLAGS += -DENABLE_PRINTF=$(ENABLE_PRINTF)
CFLAGS += -DDL_LPP=DL_ERROR
CFLAGS += -DDL_LPP_PROBE=DL_NONE
CFLAGS += -DPROBE_LOG_INTERVAL=30
CFLAGS += -DDL_LINK=DL_WARN
CFLAGS += -DDL_LINK_TIMING=DL_INFO
CFLAGS += -DDL_SCHED=DL_WARN
CFLAGS += -DDL_SCHED_RX=DL_NONE
CFLAGS += -DLOG_CTS_TIME=0
CFLAGS += -DLOG_NEIGHBORHOOD=0
CFLAGS += -DDL_ROUTER=DL_ERROR
CFLAGS += -DDL_ROUTING=DL_WARN
#printf
CFLAGS += -DNEW_PRINTF_SEMANTICS
CFLAGS += -DDL_BASESTATION=DL_ERROR
CFLAGS += -DDL_GLOBAL=DL_DEBUG

CFLAGS +=-DCC430_PIN_DEBUG=1
STORAGEDIR = $(TOSDIR)/platforms/bacon/chips/stm25p

#TESTING ONLY
LPP_DEFAULT_PROBE_INTERVAL?=1024UL
CFLAGS += -DLPP_DEFAULT_PROBE_INTERVAL=$(LPP_DEFAULT_PROBE_INTERVAL)

SLOT_LIMIT ?= 255
CFLAGS += -DSLOT_LIMIT=$(SLOT_LIMIT)

#LPP control messages
LPPMIGDIR = lpp
MIGCLASSES = $(LPPMIGDIR)/CxLppCts.py $(LPPMIGDIR)/CxLppSleep.py $(LPPMIGDIR)/CxLppWakeup.py 

CXMIGDIR = cx/messages
MIGCLASSES += $(CXMIGDIR)/CxDownload.py $(CXMIGDIR)/CtrlAck.py $(CXMIGDIR)/CxDownloadFinished.py $(CXMIGDIR)/StatusTimeRef.py

SSMIGDIR = $(CXMIGDIR)
MIGCLASSES += $(SSMIGDIR)/SetSettingsStorageMsg.py

APMIGDIR = autoPush/messages
MIGCLASSES += $(APMIGDIR)/CxRecordRequestMsg.py $(APMIGDIR)/LogRecordDataMsg.py

PINGMIGDIR = $(APMIGDIR)
MIGCLASSES += $(PINGMIGDIR)/PingMsg.py $(PINGMIGDIR)/PongMsg.py 

PRINTFMIGDIR = $(APMIGDIR)
MIGCLASSES += $(PRINTFMIGDIR)/PrintfMsg.py


$(LPPMIGDIR):
	mkdir -p $(LPPMIGDIR)

$(LPPMIGDIR)/%.py: $(LPPMIGDIR)
	genMig.sh $(PLATFORM) $(TOSDIR)/lib/cxl/mac/CXMac.h $@ $(CFLAGS) 

$(CXMIGDIR):
	mkdir -p $(CXMIGDIR)

$(CXMIGDIR)/CxDownload.py: $(CXMIGDIR)
	genMig.sh $(PLATFORM) $(TOSDIR)/lib/cxl/scheduler/CXRouter.h $@ $(CFLAGS) 

$(CXMIGDIR)/%.py: $(CXMIGDIR)
	genMig.sh $(PLATFORM) basestation.h $@ $(CFLAGS) 

$(PINGMIGDIR):
	mkdir -p $(PINGMIGDIR)

$(PINGMIGDIR)/%.py: $(PINGMIGDIR)
	genMig.sh $(PLATFORM) $(TOSROOT)/apps/breakfast/bacon/Ping/ping.h $@ $(CFLAGS) 

$(APMIGDIR):
	mkdir -p $(APMIGDIR)

$(APMIGDIR)/CxRecordRequestMsg.py: $(APMIGDIR)
	genMig.sh $(PLATFORM) $(TOSROOT)/apps/breakfast/bacon/autoPush/RecordRequest.h $@ $(CFLAGS)

$(APMIGDIR)/LogRecordDataMsg.py: $(APMIGDIR) 
	genMig.sh $(PLATFORM) $(STORAGEDIR)/RecordStorage.h $@ $(CFLAGS)

$(PRINTFMIGDIR):
	mkdir -p $(PINGMIGDIR)

$(PRINTFMIGDIR)/PrintfMsg.py: 
	mig python -target=$(PLATFORM) $(CFLAGS) -python-classname=PrintfMsg $(TOSDIR)/lib/printf/printf.h printf_msg -o $@

$(SSMIGDIR)/SetSettingsStorageMsg.py: $(SSMIGDIR)
	genMig.sh $(PLATFORM) $(TOSROOT)/apps/breakfast/bacon/settingsStorage/SettingsStorage.h $@ $(CFLAGS)

migClasses: $(MIGCLASSES)

include $(MAKERULES)
